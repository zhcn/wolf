<navigation-bar title="ç»å…¸ç©æ³•æˆ¿é—´" back="{{true}}" color="black" background="#FFF"></navigation-bar>

<view class="game-page">
  <!-- æˆ¿é—´ä¿¡æ¯æ  -->
  <view class="room-header">
    <view class="room-info">
      <text class="info-text">æˆ¿é—´: {{roomId}}</text>
      <text class="info-text">åº§ä½: {{mySeat}}å·</text>
      <text class="info-text">è½®æ•°: {{round > 0 ? round : 'å‡†å¤‡ä¸­'}}</text>
    </view>
    <view class="room-phase">
      <text class="phase-text">{{phaseText}}</text>
      <text class="phase-timer" wx:if="{{timeLeft > 0}}">{{timeLeft}}s</text>
    </view>
    <view class="room-role" wx:if="{{myRoleZh}}">
      <text class="role-label">ä½ çš„è§’è‰²:</text>
      <text class="role-value">{{myRoleZh}}</text>
    </view>
  </view>

  <!-- ä¸»æ¸¸æˆåŒºåŸŸ -->
  <view class="game-main">
    <!-- å·¦ä¾§ç©å®¶ -->
    <view class="players-side left-side">
      <view class="player-item {{item.isMe ? 'me' : ''}} {{item.seat === currentSpeaker ? 'speaking' : ''}}" wx:for="{{leftPlayers}}" wx:key="seat">
        <view class="player-avatar-wrapper">
          <image class="player-avatar" src="{{item.avatarUrl}}" mode="cover"></image>
          <!-- è§’è‰²æ ‡ç­¾ï¼ˆæ˜¾ç¤ºåœ¨å¤´åƒå·¦ä¸‹è§’ï¼‰ -->
          <block wx:if="{{playerRolesBySeat[item.seat]}}">
            <view class="role-badge" style="background-color: {{playerRolesBySeat[item.seat].color}}">
              {{playerRolesBySeat[item.seat].label}}
            </view>
          </block>
        </view>
        <view class="player-info">
          <view class="player-name">{{item.nickName}}</view>
          <view class="player-seat">{{item.seat}}å·</view>
        </view>
      </view>
    </view>

    <!-- ä¸­é—´å¯¹è¯åŒºåŸŸ -->
    <view class="dialog-area">
      <!-- ç­‰å¾…å¼€å§‹ -->
      <view class="phase-waiting" wx:if="{{phase === 'waiting'}}">
        <view class="waiting-icon">â³</view>
        <text class="waiting-text">ç­‰å¾…ç©å®¶åŠ å…¥æˆ¿é—´...</text>
        <button class="ctrl-btn primary" bindtap="startGame">å¼€å§‹æ¸¸æˆ</button>
      </view>

      <!-- è§’è‰²åˆ†é… -->
      <view class="phase-role-assign" wx:if="{{phase === 'role_assigned'}}">
        <view class="role-assign-icon">ğŸ­</view>
        <text class="role-assign-text">è§’è‰²å·²åˆ†é…ï¼</text>
        <text class="role-assign-tip">{{ myRoleZh ? 'ä½ çš„è§’è‰²æ˜¯ï¼š' + myRoleZh : 'è¯·ç¨å€™...' }}</text>
        <text class="role-assign-countdown">å³å°†è¿›å…¥ç™½å¤©è®¨è®ºé˜¶æ®µ...</text>
      </view>

      <!-- è®¨è®ºé˜¶æ®µ -->
      <view class="phase-discussing" wx:if="{{phase === 'discussing'}}">
        <view class="discussing-header">ğŸ’¬ ç™½å¤©è®¨è®º</view>
        <scroll-view class="speeches-scroll" scroll-y type="list">
          <view class="speeches" wx:if="{{speeches.length}}">
            <view class="speech-item" wx:for="{{speeches}}" wx:key="id">
              <view class="speech-header">
                <text class="speech-seat">{{item.seat}}å·</text>
                <text class="speech-time">{{item.at}}</text>
              </view>
              <view class="speech-content">{{item.text}}</view>
            </view>
          </view>
          <view class="no-speeches" wx:else>æš‚æ— å‘è¨€</view>
        </scroll-view>
        <view class="speech-input-area">
          <textarea
            class="speech-input"
            placeholder="è¾“å…¥ä½ çš„å‘è¨€..."
            value="{{speechDraft}}"
            bindinput="onSpeechInput"
            maxlength="300">
          </textarea>
          <button class="submit-speech-btn" bindtap="submitSpeech">æäº¤å‘è¨€</button>
        </view>
      </view>

      <!-- æŠ•ç¥¨é˜¶æ®µ -->
      <view class="phase-voting" wx:if="{{phase === 'voting'}}">
        <view class="voting-header">ğŸ—³ï¸ ç™½å¤©æŠ•ç¥¨</view>
        <text class="voting-tip">é€‰æ‹©è¦æŠ•ç¥¨çš„ç©å®¶</text>
        <view class="voting-players">
          <view class="vote-player-item {{item === mySeat ? 'disabled' : ''}}"
            wx:for="{{alivePlayers}}"
            wx:key="*this"
            bindtap="submitMyVote"
            data-target="{{item}}"
            wx:if="{{item !== mySeat}}">
            <view class="vote-seat">{{item}}å·</view>
          </view>
        </view>
      </view>

      <!-- æ™šä¸Šè¡ŒåŠ¨é˜¶æ®µ -->
      <view class="phase-night" wx:if="{{phase === 'night'}}">
        <view class="night-header">ğŸŒ™ æ™šä¸Šè¡ŒåŠ¨</view>
        <text class="night-tip">{{nightPhaseTip}}</text>

        <!-- ç­‰å¾…å…¶ä»–è§’è‰²è¡ŒåŠ¨ -->
        <view class="night-waiting" wx:if="{{!isMyTurn}}">
          <view class="waiting-role">ğŸ­</view>
          <text class="waiting-text">{{waitingText}}</text>
        </view>

        <!-- è½®åˆ°æˆ‘çš„è§’è‰² -->
        <view class="night-action" wx:if="{{isMyTurn}}">
          <!-- ç‹¼äººé€‰æ‹©å‡»æ€ç›®æ ‡ -->
          <view wx:if="{{myRole === 'werewolf'}}" class="action-panel">
            <text class="action-title">ğŸº é€‰æ‹©å‡»æ€ç›®æ ‡</text>
            <view class="action-targets">
              <view
                class="target-item {{item === selectedNightTarget ? 'selected' : ''}}"
                wx:for="{{alivePlayers}}"
                wx:key="*this"
                bindtap="selectNightTarget"
                data-target="{{item}}">
                <view class="target-seat">{{item}}å·</view>
              </view>
            </view>
            <button class="action-btn" bindtap="submitNightAction" disabled="{{!selectedNightTarget}}">
              {{selectedNightTarget ? 'å‡»æ€ ' + selectedNightTarget + 'å·' : 'é€‰æ‹©ç›®æ ‡'}}
            </button>
          </view>

          <!-- é¢„è¨€å®¶æŸ¥éªŒç›®æ ‡ -->
          <view wx:if="{{myRole === 'seer'}}" class="action-panel">
            <text class="action-title">ğŸ”® é€‰æ‹©æŸ¥éªŒç›®æ ‡</text>
            <view class="action-targets">
              <view
                class="target-item {{item === selectedNightTarget ? 'selected' : ''}}"
                wx:for="{{alivePlayers}}"
                wx:key="*this"
                bindtap="selectNightTarget"
                data-target="{{item}}">
                <view class="target-seat">{{item}}å·</view>
              </view>
            </view>
            <button class="action-btn" bindtap="submitNightAction" disabled="{{!selectedNightTarget}}">
              {{selectedNightTarget ? 'æŸ¥éªŒ ' + selectedNightTarget + 'å·' : 'é€‰æ‹©ç›®æ ‡'}}
            </button>
          </view>

          <!-- å¥³å·«é€‰æ‹©è¯æ°´ -->
          <view wx:if="{{myRole === 'witch'}}" class="action-panel">
            <text class="action-title">ğŸ§™ é€‰æ‹©è¯æ°´</text>
            <view class="witch-options">
              <view
                class="option-btn {{selectedWitchAction === 'save' ? 'selected' : ''}}"
                bindtap="selectWitchAction"
                data-action="save">
                <view class="option-icon">ğŸ’Š</view>
                <view class="option-text">ä½¿ç”¨è§£è¯</view>
              </view>
              <view
                class="option-btn {{selectedWitchAction === 'poison' ? 'selected' : ''}}"
                bindtap="selectWitchAction"
                data-action="poison">
                <view class="option-icon">â˜ ï¸</view>
                <view class="option-text">ä½¿ç”¨æ¯’è¯</view>
              </view>
              <view
                class="option-btn {{selectedWitchAction === 'none' ? 'selected' : ''}}"
                bindtap="selectWitchAction"
                data-action="none">
                <view class="option-icon">â¸ï¸</view>
                <view class="option-text">ä¸ä½¿ç”¨</view>
              </view>
            </view>
            <button class="action-btn" bindtap="submitNightAction" disabled="{{!selectedWitchAction || selectedWitchAction === 'none'}}">
              {{getWitchActionText()}}
            </button>
          </view>

          <!-- çŒäººã€æ‘æ°‘ç­‰å¾… -->
          <view wx:if="{{myRole === 'hunter' || myRole === 'villager'}}" class="action-panel">
            <text class="action-title">â³ ç­‰å¾…å…¶ä»–è§’è‰²è¡ŒåŠ¨</text>
            <text class="waiting-detail">ç‹¼äººã€å¥³å·«ã€é¢„è¨€å®¶æ­£åœ¨è¡ŒåŠ¨ä¸­...</text>
          </view>
        </view>
      </view>

      <!-- ç»“æœå±•ç¤º -->
      <view class="phase-result" wx:if="{{phase === 'result'}}">
        <view class="result-header">ğŸ“Š ä»Šæ—¥ç»“æœ</view>
        <text class="result-tip">å³å°†è¿›å…¥ä¸‹ä¸€é˜¶æ®µ...</text>
      </view>

      <!-- æ¸¸æˆç»“æŸ -->
      <view class="phase-game-over" wx:if="{{phase === 'game_over'}}">
        <view class="game-over-icon">ğŸ‰</view>
        <text class="game-over-text">æ¸¸æˆç»“æŸï¼</text>
        <button class="ctrl-btn primary" bindtap="startGame">é‡æ–°å¼€å§‹</button>
      </view>
    </view>

    <!-- å³ä¾§ç©å®¶ -->
    <view class="players-side right-side">
      <view class="player-item {{item.isMe ? 'me' : ''}} {{item.seat === currentSpeaker ? 'speaking' : ''}}" wx:for="{{rightPlayers}}" wx:key="seat">
        <view class="player-info">
          <view class="player-name">{{item.nickName}}</view>
          <view class="player-seat">{{item.seat}}å·</view>
        </view>
        <view class="player-avatar-wrapper">
          <image class="player-avatar" src="{{item.avatarUrl}}" mode="cover"></image>
          <!-- è§’è‰²æ ‡ç­¾ï¼ˆæ˜¾ç¤ºåœ¨å¤´åƒå·¦ä¸‹è§’ï¼‰ -->
          <block wx:if="{{playerRolesBySeat[item.seat]}}">
            <view class="role-badge" style="background-color: {{playerRolesBySeat[item.seat].color}}">
              {{playerRolesBySeat[item.seat].label}}
            </view>
          </block>
        </view>
      </view>
    </view>
  </view>
</view>

