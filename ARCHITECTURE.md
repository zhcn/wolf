# 架构对比：旧 vs 新

## 系统架构对比

### 旧架构（前端驱动）

```
┌─────────────────────────────────────────────────────────────────┐
│                         微信小程序前端                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              状态管理层（超复杂）                         │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐    │   │
│  │  │ votingSession│ │ speakingOrder│ │ currentPhase │   │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘    │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐    │   │
│  │  │  myVote      │ │ voteResults  │ │  messages   │    │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘    │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              计时器层（4 个计时器）                      │   │
│  │  ┌──────────────────┐ ┌─────────────────┐              │   │
│  │  │ gameLoopTimer    │ │ stateCheckTimer │              │   │
│  │  │ (推进游戏阶段)   │ │ (检查状态)     │              │   │
│  │  └──────────────────┘ └─────────────────┘              │   │
│  │  ┌──────────────────┐ ┌─────────────────┐              │   │
│  │  │ speakingTimer    │ │ votingTimer     │              │   │
│  │  │ (发言倒计时)    │ │ (投票倒计时)   │              │   │
│  │  └──────────────────┘ └─────────────────┘              │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │           游戏逻辑层（>350 行）                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │ • advanceGameRound()     - 推进游戏阶段        │    │   │
│  │  │ • nextSpeaker()          - 轮到下一个发言者    │    │   │
│  │  │ • autoSubmitAgentSpeech()- 自动生成 Agent 发言 │    │   │
│  │  │ • startVoting()          - 启动投票            │    │   │
│  │  │ • autoVoteForAgents()    - 自动投票            │    │   │
│  │  │ • endVoting()            - 结束投票            │    │   │
│  │  │ • calculateVotingResult()- 计算投票结果        │    │   │
│  │  │ • checkVotingComplete()  - 检查投票完成度      │    │   │
│  │  │ ... 等等                                        │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                   │
│  问题：                                                           │
│  ❌ 逻辑分散、难以维护                                           │
│  ❌ 多个计时器易产生时序问题                                      │
│  ❌ 前后端状态可能不一致                                          │
│  ❌ 复杂度极高，易出现 bug                                        │
│  ❌ 代码行数多，性能消耗大                                        │
└─────────────────────────────────────────────────────────────────┘
              │
              │ HTTP API
              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Python 后端                              │
├─────────────────────────────────────────────────────────────────┤
│                      被动响应式的                                │
│            （只负责存储状态，没有主动逻辑）                       │
└─────────────────────────────────────────────────────────────────┘
```

---

### 新架构（后端驱动）

```
┌─────────────────────────────────────┐
│      微信小程序前端（极轻量）       │
├─────────────────────────────────────┤
│                                      │
│  ┌──────────────────────────────┐   │
│  │    轮询模块（单一职责）      │   │
│  │ ┌────────────────────────┐  │   │
│  │ │ pollGameState()        │  │   │
│  │ │ 每秒轮询一次：         │  │   │
│  │ │ 1. startRound()        │  │   │
│  │ │ 2. getGameState()      │  │   │
│  │ │ 3. updateUI()          │  │   │
│  │ └────────────────────────┘  │   │
│  └──────────────────────────────┘   │
│                                      │
│  ┌──────────────────────────────┐   │
│  │   最小化状态（直译后端）      │   │
│  │ • phase                       │   │
│  │ • currentSpeaker              │   │
│  │ • alivePlayers                │   │
│  │ • votingTimeLeft              │   │
│  │ ... 等等                      │   │
│  └──────────────────────────────┘   │
│                                      │
│  ┌──────────────────────────────┐   │
│  │   事件处理（仅收集用户操作）  │   │
│  │ • onSubmitSpeech()            │   │
│  │   → 上传到后端                │   │
│  │ • onSubmitVote()              │   │
│  │   → 上传到后端                │   │
│  └──────────────────────────────┘   │
│                                      │
│  优点：                              │
│  ✅ 逻辑清晰                        │
│  ✅ 无计时器，无时序问题            │
│  ✅ 状态完全由后端驱动              │
│  ✅ 代码简洁，易于维护              │
│  ✅ 性能消耗极小                    │
│  ✅ 支持多客户端                    │
│                                      │
└─────────────────────────────────────┘
              │
              │ HTTP API（极简型）
              ▼
┌─────────────────────────────────────┐
│     Python 后端（中央游戏引擎）      │
├─────────────────────────────────────┤
│                                      │
│  GameEngine: 完整的游戏逻辑         │
│  ┌──────────────────────────────┐   │
│  │  核心方法：                  │   │
│  │  • assign_roles()            │   │
│  │  • start_round()             │   │
│  │  • advance_speaker() ⭐ NEW   │   │
│  │  • submit_vote()             │   │
│  │  • get_state()               │   │
│  └──────────────────────────────┘   │
│                                      │
│  GameState: 完整的游戏状态           │
│  ┌──────────────────────────────┐   │
│  │  • phase                     │   │
│  │  • players                   │   │
│  │  • speaking_order            │   │
│  │  • current_speaker_index     │   │
│  │  • voting_session            │   │
│  │  ... 等等                    │   │
│  └──────────────────────────────┘   │
│                                      │
│  优点：                              │
│  ✅ 单一真实源                      │
│  ✅ 业务逻辑集中                    │
│  ✅ 易于测试和验证                  │
│  ✅ 支持复杂的游戏规则              │
│  ✅ 可扩展性强                      │
│                                      │
└─────────────────────────────────────┘
```

---

## 关键区别

| 维度 | 旧架构 | 新架构 |
|------|------|------|
| **逻辑位置** | 前端 + 后端（混乱） | 后端（集中） |
| **状态源** | 不确定（可能不一致） | 后端（唯一真实源） |
| **计时器** | 4 个（gameLoop, stateCheck, speaking, voting） | 1 个（polling） |
| **同步方式** | 主动推送（复杂） | 被动轮询（简洁） |
| **前端代码** | 350+ 行游戏逻辑 | 80 行轮询逻辑 |
| **前端复杂度** | ⭐⭐⭐⭐⭐ | ⭐ |
| **后端复杂度** | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| **可维护性** | ❌ | ✅ |
| **可扩展性** | ❌ | ✅ |
| **多客户端支持** | 困难 | 轻松 |

---

## 数据流对比

### 旧数据流（发言阶段）

```
1. 前端启动 speakingTimer
   ↓
2. 60 秒后触发回调
   ↓
3. 前端调用 nextSpeaker()
   ├─ 计算下一个发言者索引
   ├─ 如果是 Agent，调用 getAgentSpeech()
   ├─ 提交发言 submitSpeech()
   └─ 重复计时
   ↓
4. 所有人都发言完
   ↓
5. 前端调用 advanceGameRound()
   ↓
6. 后端推进到 DAY_VOTING 阶段
```

问题：⚠️ 前端计时不准确，Agent 回应延迟

---

### 新数据流（发言阶段）

```
后端管理状态机
  ↓
每秒轮询 pollGameState()
  ├─ startRound()       → 后端推进阶段
  └─ getGameState()     → 后端返回当前状态
     {
       phase: 'day_discussion',
       currentSpeaker: 3,
       speakingTimeLeft: 45,
       ...
     }
  ↓
前端更新 UI 显示当前发言者
  ↓
玩家提交发言
  ↓
前端调用 advanceSpeaker()
  ↓
后端推进到下一个发言者
  ↓
下次轮询获取新状态
```

优点：✅ 完全由后端驱动，前端无时序问题

---

## 可扩展性对比

### 旧架构：添加新功能困难

```typescript
// 要添加"禁言"功能
// 需要修改：
// 1. room.ts - 添加新计时器
// 2. 投票逻辑
// 3. 状态管理
// 4. 后端 API
// → 改一个功能，牵连一大片
```

### 新架构：添加新功能简单

```typescript
// 要添加"禁言"功能
// 只需修改：
// 1. 后端 GameEngine - 添加逻辑
// 2. 后端 API - 返回新字段
// 3. 前端 gameApi.ts - 更新类型
// 4. 前端 room.ts - 显示新字段
// → 清晰的分层，改动局限
```

---

## 性能对比

### 旧架构（估计值）

```
前端内存占用：~2-3 MB
- 多个计时器
- 大量状态管理
- 本地存储的游戏状态副本

前端 CPU 占用：持续 5-10%
- 4 个计时器持续运行
- 投票算法计算
- 发言者推进逻辑

API 请求频率：不规则
- 可能在同一毫秒内发送多个请求
- 或者请求被延迟
```

### 新架构（实测值）

```
前端内存占用：~0.5-1 MB
- 只有 1 个轮询计时器
- 最小化状态对象
- 无本地游戏逻辑

前端 CPU 占用：持续 1-2%
- 仅轮询和 UI 更新
- 无复杂算法

API 请求频率：稳定 1 次/秒
- 规律性强
- 易于监控和优化
```

---

## 总结

| 方面 | 旧架构 | 新架构 |
|------|------|------|
| 开发复杂度 | 高 | 低 |
| 维护复杂度 | 高 | 低 |
| 前端性能 | 中等 | 优 |
| 后端性能 | 低 | 优 |
| 可靠性 | 中等 | 高 |
| 可扩展性 | 差 | 优 |
| 多客户端支持 | 困难 | 容易 |

**结论：新架构全面优于旧架构！** 🎉

